# qemu的结构

通过chatGPT辅助，可以了解到qemu由以下几个大部分组成：

1、处理器模拟器

2、设备模拟器

3、TCG

4、KVM

5、配置管理和命令行接口

## 开发流程

对于QEMU而言，"Hypervisor"（虚拟化监视器）指的是QEMU本身。

对于QEMU仿真的固件，你可以按照类似的流程进行处理：

1. 在Hypervisor中配置虚拟机的基本环境，包括大小、内核、指令集等方面的设置。
2. 在QEMU中使用QOM机制，自定义特定的硬件资源，并进行管理和配置。这些硬件资源可以是与固件所需的外设、传感器、网络等相关的。
3. 在Hypervisor中进行初始化，分配适当的硬件资源给虚拟机，并确保虚拟机与QEMU之间的通信通道建立。
4. 使用Virtio作为设备模型和通信机制，实现虚拟机与QEMU模拟的硬件资源的通信。

通过这个流程，你可以为QEMU仿真的固件提供定制的硬件资源池，并实现仿真环境中固件对特定硬件的访问和通信需求。

## Virtio

Virtio是一种设备虚拟化技术，它提供了一种标准化的设备接口和协议，用于在虚拟机和宿主机之间进行高性能和低延迟的数据传输。虚拟机中的客户操作系统可以使用Virtio接口与虚拟化环境中的设备进行通信。

可以说Virtio在QEMU中是一种用于设备虚拟化的框架，它帮助**管理和提供虚拟机对所需硬件或设备资源的访问**。它与Hypervisor不同，**Hypervisor更关注虚拟机的管理和资源调度**，而Virtio更关注虚拟机内部设备与虚拟化环境中设备模拟之间的通信和数据传输。



## QOM

QEMU提供了QOM（QEMU Object Model）来定义和创建仿真固件所需的硬件资源。c实现的面向对象编程。

C的封装、继承、多态可[见此](https://blog.csdn.net/onlyshi/article/details/81672279)。

QOM是QEMU中的一个对象模型，它允许定义和创建具有层次结构的硬件设备和虚拟机组件。使用QOM，可以将不同类型的设备和组件组合在一起，构建出完整的仿真环境。

通过QOM，可以创建各种类型的设备，例如处理器、存储设备、网络设备、显示设备等。这些设备可以具有属性、方法和信号，以及与其他设备之间的连接。

使用QOM定义仿真固件所需的硬件资源，可以方便地构建和配置仿真环境。通过创建适当的设备对象并将其连接起来，可以模拟出所需的硬件配置，以满足仿真固件的需求。

总结来说，QOM提供了一种灵活且可扩展的方式来定义和创建仿真固件所需的硬件资源。通过QOM的对象模型，可以组合和配置各种设备，以构建出完整的仿真环境。



QEMU中的**虚拟设备模型**是使用QOM（QEMU Object Model）来实现的。

QOM提供了一种对象模型，允许定义和创建各种虚拟设备。通过QOM，可以将不同类型的设备组合在一起，构建出完整的仿真环境。

在QEMU中，每个虚拟设备都由一个QOM类表示，该类继承自QOM的基类，并定义了设备的属性、方法和信号。通过创建设备类的实例，可以实例化虚拟设备，并在仿真环境中使用它。

虚拟设备类可以使用QOM提供的特性，如继承、组合和属性机制，以及与其他设备之间的连接和通信。这样，可以构建出复杂的设备层次结构，并实现设备之间的交互和通信。

通过使用QOM，QEMU能够灵活地创建和配置各种虚拟设备，并提供了丰富的设备模型来满足不同仿真需求。QOM的对象模型为QEMU的虚拟设备提供了一种可扩展和可定制的框架。



## 事件循环机制

qemu中的事件循环机制就是在做“fd事件”的处理

"fd事件"是一个抽象概念，而不是Linux系统中的特定命令或API。

文件描述符（File Descriptor，简称fd）是操作系统提供的一种抽象概念，用于标识打开的文件、设备或管道。文件描述符是一个非负整数，它在程序中用作对打开对象的引用。

"fd事件"是**针对文件描述符的状态变化的抽象概念**。当文件描述符准备好进行IO操作时，例如可读或可写，可以称之为发生了"fd事件"。这个概念用于指示文件描述符的状态已经发生变化，可以进行相应的读取或写入操作。


在固件模拟时，文件描述符主要**用于描述应用程序或模拟环境中的文件、设备或管道**。它们用于进行读取和写入操作，以及与这些对象进行交互。

文件描述符通常不直接用于描述内核操作的一系列变化。内核操作通常是在操作系统内核中进行的，而文件描述符主要用于用户空间程序和内核之间的通信和交互。

在Linux系统中，文件描述符主要用于表示用户空间程序打开的文件、设备或管道。它们用于访问用户空间可见的文件系统和设备。

文件描述符并不是用于描述所有可能的内核操作，而是用于描述用户空间程序可以访问和操作的文件和设备。内核操作通常在内核空间进行，涉及到内核数据结构和系统调用，而不是直接使用文件描述符。

因此，并非所有Linux内核中的操作都会被文件描述符所描述。文**件描述符主要用于用户空间程序与文件系统、设备、管道之间的通信。**



"fd事件"通常涉及以下几个方面：

1. 可读事件（Read Event）：当文件描述符中有数据可供读取时触发。例如，网络套接字中有新的数据可读取时，文件描述符的状态会发生变化，触发可读事件。
2. 可写事件（Write Event）：当文件描述符可接受数据写入时触发。例如，网络套接字的发送缓冲区已准备好接收新的数据时，文件描述符的状态会发生变化，触发可写事件。
3. 异常事件（Exception Event）：当文件描述符出现异常情况时触发。例如，连接断开、连接错误或其他错误发生时，文件描述符的状态会发生变化，触发异常事件。

下面是一些具体的例子，涉及到可能触发"fd事件"的情况：

1. 网络套接字：当网络套接字接收到新的数据时，文件描述符的可读事件将被触发。类似地，当发送缓冲区可接受新数据时，文件描述符的可写事件将被触发。
2. 管道：当管道中有数据可供读取时，管道文件描述符的可读事件将被触发。类似地，当管道的写入端口可以接受新数据时，管道文件描述符的可写事件将被触发。
3. 文件：对于文件描述符表示的文件，可读事件表示文件有新的数据可供读取。可写事件表示文件可以接受新的数据写入。
4. 定时器：定时器可以使用文件描述符和定时器事件机制进行交互。当定时器到达设定的时间时，相应的文件描述符的可读事件或可写事件将被触发。





## 通信协议

### QMP

QEMU使用QMP（QEMU Monitor Protocol）与虚拟机进行通信和管理。QMP是一种与QEMU监视器交互的协议，通过该协议，管理程序（如命令行工具或脚本）可以向QEMU发送命令和查询虚拟机的状态，并接收来自QEMU的事件通知。

通过QMP，您可以执行各种操作，如启动、暂停、恢复、关闭虚拟机，添加、移除、配置设备，管理虚拟机快照，查询虚拟机状态信息等。QMP提供了丰富的命令集和功能，使得管理程序可以以编程方式与QEMU进行交互，实现对虚拟机的灵活控制和管理。

需要注意的是，QMP是一种基于JSON的协议，通常使用UNIX域套接字或TCP/IP进行通信。QEMU监视器在启动虚拟机时会打开一个监视器控制台，允许外部管理程序通过QMP与其通信。这使得管理程序可以在运行中的虚拟机上执行管理操作，而无需干预虚拟机本身。

总结而言，QMP是QEMU与虚拟机进行通信和管理的协议，它提供了一种灵活且功能丰富的方式，用于控制和管理QEMU虚拟机。——chatgpt



现在的QEMU底层是通过qmp完成功能的，只是还保留了hmp的接口。——book

QEMU在早期版本中使用HMP（Human Monitor Protocol）命令作为与虚拟机进行交互的一种机制。HMP提供了一个类似于命令行界面的交互式监视器，允许用户通过输入命令来管理和操作虚拟机。

然而，随着QEMU的发展，QMP（QEMU Monitor Protocol）逐渐取代了HMP成为主要的管理和监控协议。QMP提供了更强大和灵活的功能，以编程方式与QEMU进行交互，支持更多的管理操作和状态查询。相比之下，HMP的功能相对有限。

因此，在当前版本的QEMU中，QMP是与虚拟机进行通信和管理的主要协议，而HMP的使用相对较少。大多数管理操作和查询可以通过QMP命令来完成。——chatgpt





## 有关QOM的文件在哪儿？

从[qemu-object-model](https://github.com/Gyumeijie/qemu-object-model)的github项目可知，QOM有关的文件都在这个项目的文件夹里（这个项目拉取了qemu QOM相关的文件）。但是实际的qemu项目中这些文件都分散在各个文件夹中，得锁定一下位置才好知道该如何修改。

qemu开发文档只是给了个简单[示例](https://www.qemu.org/docs/master/devel/qom.html)，但这个示例没有告诉我们要修改哪些文件





